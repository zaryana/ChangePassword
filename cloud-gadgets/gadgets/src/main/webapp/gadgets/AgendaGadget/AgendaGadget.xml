<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs author="eXoPlatform"
    title="Agenda Gadget v.2"
    title_url="http://www.exoplatform.org"
    description="Tasks and Upcoming Event list.">
    <Locale messages="locale/default.xml" />
    <Locale lang="fr" messages="locale/fr.xml" />
    <Require feature="setprefs"/>
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[
    <link rel="stylesheet" href="css/Agenda.css" type="text/css" />
    <link type="text/css" rel="stylesheet" href="/exo-gadget-resources/skin/exo-gadget/gadget-common.css" />
    <script type="text/javascript" src="/exo-gadget-resources/script/jquery/1.6.2/jquery.min.js"></script>
    <script type="text/javascript" src="/portal/javascript/merged.js"></script>
    <script type="text/javascript" src="/csResources/javascript/eXo/cs/UIDateTimePicker.js"></script>    
    <script type="text/javascript" src="js/Agenda.js"></script>
    
		<script type="text/javascript">
		        function showForm(isShow) {
		                document.getElementById("message").innerHTML = "";
		        	var frm = document.getElementById("addEventForm");
	                        var display = "";
	                        if(isShow) {
	                                eXoEventGadget.init();
		                        display = "block";
		                        document.getElementById("add-link").style.display = "none";
                                } else {
                                        display = "none";
                                        document.getElementById("add-link").style.display = "block";
                                }
	                        frm.style.display = display;
	                        gadgets.window.adjustHeight($("#CalendarGadget").get(0).offsetHeight);
		        }
		        
                        function initCalendar(obj, bool) {
                                eXo.cs.UIDateTimePicker.init(obj,bool);
                                document.getElementById("UICalendarControl").style.bottom = "210px";
                                gadgets.window.adjustHeight($("#CalendarGadget").get(0).offsetHeight);
                        }
                        
                        function showCalendar() {
                                eXo.cs.UIDateTimePicker.show();
                                gadgets.window.adjustHeight($("#CalendarGadget").get(0).offsetHeight);
                        }
                        
                        function extract_hour(hourTime){
                                var hour = 0;
                                if (hourTime.indexOf("AllDay") == -1) { 
                                        hour = parseInt(hourTime.substring(0, 2), 10);
                                        var APM = hourTime.substring(2, hourTime.length);
                                        if (APM.indexOf("PM") != -1) hour += 12;
                                }
                                return hour*3600*1000;
                        }                        

                        function addEvent() {
                                var addForm = document.getElementById("addEventForm");
                                var title = addForm["title"].value;
                                if (title.length == 0) {
                                        document.getElementById("message").innerHTML = '<div class="MessageError">__MSG_error__</div>';
                                } else {
                                        document.getElementById("message").innerHTML = "";
                                        var eventType = addForm["eventType"].options[addForm["eventType"].selectedIndex].value;
                                        var fromString = addForm["from"].value;
                                        var fromTime = addForm["fromTime"].options[addForm["fromTime"].selectedIndex].value;
                                        var from = Date.parse(fromString) + extract_hour(fromTime);
                                        var to = 0;
                                        if (addForm["to"].disabled) {
                                                to = from + (24 * 3600 * 1000 - 1);
                                        } else {
                                                var toString = addForm["to"].value;
                                                var toTime = addForm["toTime"].options[addForm["toTime"].selectedIndex].value;
                                                to = Date.parse(toString) + extract_hour(toTime);
                                        }
                                        var calendar = addForm["calendar"].options[addForm["calendar"].selectedIndex].value;
                                        var dataString = 'calId='+ calendar + '&eventTitle=' + encodeURIComponent(title) + '&from=' + from + '&to=' + to + '&eventType=' + eventType;
          
                                        $.ajax({  
                                                type: "POST",  
                                                url: "/rest/calendar/addevent",  
                                                data: dataString,  
                                                success: function() {
                                                        var listEventType = document.getElementById("eventType");
                                                        var eventType = listEventType.options[listEventType.selectedIndex].text;
                                                        eXoEventGadget.getData();
                                                        showForm(false);
                                                        document.getElementById("message").innerHTML = '<div class="MessageSuccess">' + eventType + ' __MSG_added__</div>';
                                                        //$('#message').fadeOut(200, function(){
                                                        //        gadgets.window.adjustHeight($("#CalendarGadget").get(0).offsetHeight);
                                                        //});
                                                },
                                                error: function(request, status, error){
                                                    if (request.responseText.indexOf("Selected time") != -1) {
                                                        document.getElementById("message").innerHTML = '<div class="MessageError">__MSG_selectTime__</div>';
                                                    } else {
                                                        document.getElementById("message").innerHTML = '<div class="MessageError">' + request.responseText + '</div>';
                                                    }
                                                        gadgets.window.adjustHeight($("#CalendarGadget").get(0).offsetHeight);
                                                }
                                        });           
      
                                }
                                gadgets.window.adjustHeight($("#CalendarGadget").get(0).offsetHeight);
                        }
                        
                        function onSelectionChange() {
                                var selectIndex = document.getElementById("fromTime").selectedIndex;
                                var selectedDate = document.getElementById("from").value;
                                var toInput = document.getElementById("to");
                                var toSelect = document.getElementById("toTime");
                                var hours = ["01 AM", "02 AM", "03 AM", "04 AM", "05 AM", "06 AM", "07 AM", "08 AM", "09 AM", "10 AM", "11 AM", "12 AM", "01 PM", "02 PM", "03 PM", "04 PM", "05 PM", "06 PM", "07 PM", "08 PM", "09 PM", "10 PM", "11 PM", "12 PM"];
                                var hours_value = ["01AM", "02AM", "03AM", "04AM", "05AM", "06AM", "07AM", "08AM", "09AM", "10AM", "11AM", "12AM", "01PM", "02PM", "03PM", "04PM", "05PM", "06PM", "07PM", "08PM", "09PM", "10PM", "11PM", "12PM"];
                                var html = '';
                                if (selectIndex == 0 || selectIndex == 24) {
                                  for (var i = 0; i < hours.length; i++) html += '<option value="' + hours_value[i] + '">' + hours[i] + '</option>';
                                } else {
                                  for (var i = selectIndex; i < hours.length; i++) html += '<option value="' + hours_value[i] + '">' + hours[i] + '</option>';
                                }
                                $("#toTime").html(html);
                                if (selectIndex == 0) {
                                        toInput.disabled = true;
                                        toSelect.disabled = true;
                                        toInput.value = DateTimeFormater.format((new Date()),"mm/dd/yyyy");
                                } else {
                                        toInput.disabled = false;
                                        toSelect.disabled = false;
                                        if (selectIndex == 24) {
                                          var toDateInMillis = Date.parse(selectedDate) + 24 * 3600 * 1000;
                                          toInput.value = DateTimeFormater.format((new Date(toDateInMillis)),"mm/dd/yyyy");
                                        } else {
                                          toInput.value = selectedDate;
                                        }
                                }
                        }
      
                        function changeToDate() {
                          var hours = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
                          var APM = ["AM", "PM"];
                          var html = '';
                          for (var i = 0; i < 2; i++)
                            for (var j = 0; j < 12; j++) {
                              html += '<option value="' + hours[j] + APM[i] + '">' + hours[j] +  " " + APM[i] + '</option>';
                            }
                          $("#toTime").html(html);
                        }
                        
                        $(".Weekday").live("click", function(){
                          var isCalendarOfFrom = $(this).closest("#UICalendarControl").next("input").attr("id");
                          if (isCalendarOfFrom.indexOf("from") != -1) {
                            var hrefValue = $(this).attr("href");
                            var subHref = hrefValue.substring(0, hrefValue.lastIndexOf(","));
                            var day = hrefValue.substring(hrefValue.lastIndexOf(',')+1, hrefValue.lastIndexOf(')'));
                            var month = subHref.substring(subHref.lastIndexOf(',')+1, subHref.length);
                            day = (day.length == 1) ? ("0" + day) : day;
                            month = (month.length == 1) ? ("0" + month) : month;
                            var year = subHref.substring(subHref.lastIndexOf(',')-4, subHref.lastIndexOf(','));
                            $("#to").val(month + "/" + day + "/" + year);
                          }
                        });                       		        
		</script>    
    
  <div id="CalendarGadget">
    <div id="Calendar" class="UIGadgetThemes">

        <div class="gadgetTitle">__MSG_titlegadget__</div>
      
        <div id="gadget-Content"> 

           <div class="listEvent" id="eventDiv">
           </div>
           
           <div id="addForm" class="addLink">
                <a id="add-link" href="#" onclick="showForm(true);">+ __MSG_addEvent__</a>
	        <form id="addEventForm" action="#" style="display: none;">
                  <table class="add-table">
                     <tr>
                          <td><label for="eventType">__MSG_add__: </label></td>
                          <td class="select-eventtype">
                               <select id="eventType">
                               </select>
                          </td>                      
                    </tr>

                    <tr>      
                          <td><label for="title">__MSG_eventTitle__: </label></td>
                          <td class="Row RowTitle"><input id="title" type="text" /></td>
                    </tr>

                    <tr>
                          <td><label for="from">__MSG_from__: </label></td>
                          <td class="Row RowFromTo"><input id="from" type="text" size="10" lang="EN" onmousedown="event.cancelBubble = true" onkeyup="showCalendar();" onfocus="initCalendar(this, false);" format="MM/dd/yyyy" />
                                   <select id="fromTime" onchange="onSelectionChange();">
                                   </select>
                                </td>
                          </tr>                                
                    <tr>     
                          <td><label for="to">__MSG_to__: </label></td>
                          <td class="Row RowFromTo"><input id="to" type="text" size="10" lang="EN" onmousedown="event.cancelBubble = true" onblur="changeToDate();" onkeyup="showCalendar();" onfocus="initCalendar(this, false);" format="MM/dd/yyyy" />
                                   <select id="toTime">
                                   </select>
                          </td>                          
                    </tr>
                </table>   

                <table class="add-table">
                    <tr>    
                          <td class="label-calendar"><label for="calendar">__MSG_calendar__: </label></td>
                          <td class="select-calendar">
                                <select id="calendar">
                                </select>
                          </td>
                    </tr>
                    <tr>
                          <td></td>
                          <td class="Button">
                                <input type="button" value="__MSG_confirm__" id="confirm" onclick="addEvent();" />
                                <input type="button" value="__MSG_cancel__" id="cancel" onclick="showForm(false);" />
                          </td>
                    </tr>
                </table>
          </form>
           <div id="message"></div>
           <div id="calendarlink" style="display: none"></div>               
           </div>
        </div>
      </div>       
    </div>
    ]]>
  </Content>
</Module>

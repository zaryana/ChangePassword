<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs author="eXoPlatform" title="SuggestSpacesGadget">
    <Require feature="opensocial-0.8" />
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[ 
    
    <head>
      <link type="text/css" rel="stylesheet" href="/exo-gadget-resources/skin/exo-gadget/gadget-common.css" />
      <link type="text/css" rel="stylesheet" href="css/space.css" />    
      <script language="javascript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      <script type="text/javascript">
        
     function sortByMembers(a, b){
            return b.members - a.members;
        }
        
        Array.prototype.shuffle = function() {
           var len = this.length;
           var i = len;
           while (i--) {
             var p = parseInt(Math.random()*len);
            var t = this[i];
            this[i] = this[p];
            this[p] = t;
           }
        };
     
        function initInvitations() {
          
          $.getJSON("/rest/gadgets/spaces/invitations", function(items){            
                         
              if (items.length > 0){
                $("#content").show();
                $("#spaceInvite").show();
              }
            
              $.each(items, function(i, item){
                
                var link = "<li id='"+item.spaceId+"'>";
                link += "<div class='spacePicture' ><a href='#'><img src='"+item.avatarUrl+"'></a></div>";
                link += "<div class='spaceInfo'>";
                link += "<div class='spaceName'><a href='/portal/intranet/invitationSpace' target='_parent'>"+item.displayName+"</a></div>";
                link += "<div class='spaceAction' ><a class='accept' href='#' onclick='return false'>Accept</a> | <a class='deny' href='#' onclick='return false'>Deny</a></div>";
                link += "</div></li>";
                    
                $("#requests").append(link);  
                          
                gadgets.window.adjustHeight();
                
                $("#"+item.spaceId+" a.accept").live("click", function(){
                  $.getJSON("/rest/gadgets/spaces/accept/"+item.spaceId, null);
                                   
                  if($("#requests").children().length == 1) {
                      $("#spaceInvite").fadeOut(500, function () {
                          $("#"+item.spaceId).remove();
                          $("#spaceInvite").hide(); 
                          if ($("#spaceSugest").is(":hidden")){
                              $("#content").hidden();
                          }
                          gadgets.window.adjustHeight();
                      });
                  }
                  else {
                      $("#"+item.spaceId).fadeOut(500, function () {
                          $("#"+item.spaceId).remove();
                          var count = parseInt($("#inviteCounter").html());
                          $("#inviteCounter").html(count-1);
                          gadgets.window.adjustHeight();
                      });
                  }                                                    
                });
                
                $("#"+item.spaceId+" a.deny").live("click", function(){
                  $.getJSON("/rest/gadgets/spaces/deny/"+item.spaceId, null);
                                  
                  if($("#requests").children().length == 1) {
                      $("#spaceInvite").fadeOut(500, function () {
                          $("#"+item.spaceId).remove();
                          $("#spaceInvite").hide();                        
                          if ($("#spaceSuggest").is(":hidden")){
                              $("#content").hide();
                          }
                          gadgets.window.adjustHeight();
                      });
                  }
                  else {
                      $("#"+item.spaceId).fadeOut(500, function () {
                          $("#"+item.spaceId).remove();
                          var count = parseInt($("#inviteCounter").html());
                          $("#inviteCounter").html(count-1);
                          gadgets.window.adjustHeight();
                      });
                  }                   
                });
                $("#inviteCounter").html(i+1);

              });
          });                
        }
        
        function initSuggestions() {
          
          $.getJSON("/rest/gadgets/spaces/suggestions", function(items){            
              
              if (items.length > 0){
                  $("#content").show();
                  $("#spaceSuggest").show();
              }
            
              items.shuffle();
            //items.sort(sortByMembers);
            
              $.each(items, function(i, item){   
                               
                var link = "";
                
                if (i < 2)
                    { link += "<li id='"+item.spaceId+"'>";}
                else
                    { link += "<li style='display:none;' id='"+item.spaceId+"'>" }
                
                link += "<div class='spacePicture' ><a href='#'><img src='"+item.avatarUrl+"'></a></div>";
                link += "<div class='spaceInfo'>";
                link += "<div class='spaceName'><a href='/portal/intranet/all-spaces' target='_parent'>"+item.displayName+"</a></div>";
                                                
                if(item.registration == "open")
                    link += "<div class='spaceAction' ><a class='connect' href='/portal/g/:spaces:"+item.name+"/"+item.name+"' target='_parent'>Join</a>";
                else
                    link += "<div class='spaceAction' ><a class='connect' href='#' onclick='return false'>Request</a>";
                
                link += "  | <a class='ignore' href='#' onclick='return false'>Ignore</a></div>";
                link += "</div></li>";
               
                $("#suggestions").append(link);           
                   
                gadgets.window.adjustHeight();
                                
                $("#"+item.spaceId+" a.connect").live("click", function(){
                  if(item.registration == "open")
                    $.getJSON("/rest/gadgets/spaces/join/"+item.spaceId, null);
                  else
                    $.getJSON("/rest/gadgets/spaces/request/"+item.spaceId, null);
                  
                  if($("#suggestions").children().length == 1) {
                      $("#spaceSuggest").fadeOut(500, function () {   
                          $("#"+item.spaceId).remove();
                          $("#spaceSuggest").hide();
                          if ($("#spaceInvite").is(":hidden")){
                              $("#content").hide();
                          }
                          gadgets.window.adjustHeight();
                      });  
                  }
                  else {
                      $("#"+item.spaceId).fadeOut(500, function () {   
                          $("#"+item.spaceId).remove();
                          $('#suggestions li:hidden:first').fadeIn(500, function() {});
                          gadgets.window.adjustHeight();
                      });   
                  }                  
                });
                
                $("#"+item.spaceId+" a.ignore").live("click", function(){
                  //$.getJSON("/rest/gadgets/people/contacts/ignore/"+item.suggestionId, null);
                  if($("#suggestions").children().length == 1) {
                      $("#spaceSuggest").fadeOut(500, function () {   
                          $("#"+item.spaceId).remove();
                          $("#spaceSuggest").hide();                       
                          if ($("#spaceInvite").is(":hidden")){
                              $("#content").hide();
                          }
                          gadgets.window.adjustHeight();
                      });  
                  }
                  else {
                      $("#"+item.spaceId).fadeOut(500, function () {   
                          $("#"+item.spaceId).remove();
                          $('#suggestions li:hidden:first').fadeIn(500, function() {});
                          gadgets.window.adjustHeight();
                      });  
                  }
              });

              });
          });                
        }
                
                   
        gadgets.util.registerOnLoadHandler(function(){  
       
            gadgets.window.adjustHeight();
            initInvitations();
            initSuggestions();
        });
       
      </script>         
      
    </head>
    
    <body>
      <div style="display:none;" id="content">
        <div id="SpaceGadget" class="UIGadgetThemes">
                            
            <div style="display:none;" class="spaceList" id="spaceInvite">
                <div class='spaceHeader'>Space Invitations (<span id='inviteCounter'></span>)</div><ul id='requests'></ul>
            </div>
            
            <div style="display:none;" class="spaceList" id="spaceSuggest">
                <div class='spaceHeader'>Space Suggestions</div><ul id='suggestions'></ul>
            </div>
                      
        </div>
      </div>
    </body>
    
    
    ]]></Content></Module>
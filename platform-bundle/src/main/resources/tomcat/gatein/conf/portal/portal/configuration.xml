<?xml version="1.0" encoding="ISO-8859-1"?>
<!--

    Copyright (C) 2010 eXo Platform SAS.

    This is free software; you can redistribute it and/or modify it
    under the terms of the GNU Lesser General Public License as
    published by the Free Software Foundation; either version 2.1 of
    the License, or (at your option) any later version.

    This software is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
    Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public
    License along with this software; if not, write to the Free
    Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
    02110-1301 USA, or see the FSF site: http://www.fsf.org.

-->
<configuration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.exoplatform.org/xml/ns/kernel_1_2.xsd http://www.exoplatform.org/xml/ns/kernel_1_2.xsd"
  xmlns="http://www.exoplatform.org/xml/ns/kernel_1_2.xsd">

  <component>
    <key>PropertyManagerConfigurator</key>
    <type>org.exoplatform.container.PropertyConfigurator</type>
    <init-params>
      <value-param>
        <name>properties.url</name>
        <value>file:${catalina.home}/${exo.conf.dir.name}/cloud.properties</value>
      </value-param>
    </init-params>
  </component>

  <component>
    <key>org.exoplatform.services.security.Authenticator</key>
    <type>com.exoplatform.cloudworkspaces.organization.authenticator.IntranetAuthenticatorImpl</type>
  </component>

  <component>
    <key>org.exoplatform.cloudmanagement.multitenancy.CreateNewRepositoryPlugin</key>
    <!-- type>org.exoplatform.cloudmanagement.multitenancy.CreateNewRepositoryPlugin</type -->
    <!-- impl with support of JCR Value storages -->
    <type>org.exoplatform.platform.cloud.services.multitenancy.CreateNewRepositoryPlugin</type>
    <description>Create database</description>
    <init-params>
      <value-param>
        <name>priority</name>
        <value>10</value>
      </value-param>
      <value-param>
        <name>configuration-path</name>
        <value>file:///${catalina.home}/${exo.conf.dir.name}/cloud/platform-tenant-configuration-template.xml</value>
      </value-param>
    </init-params>
  </component>

  <!-- use old-style paths for users, required for eXo Intranet migration only -->
  <!-- component>
    <key>org.exoplatform.services.jcr.ext.hierarchy.NodeHierarchyCreator</key>
    <type>org.exoplatform.services.jcr.ext.hierarchy.impl.NodeHierarchyCreatorImpl</type>
    <init-params>
       <value-param>
         <name>old-user-distribution</name>
         <value>true</value>
       </value-param>
     </init-params>
  </component -->

  <component>
    <key>org.exoplatform.services.jcr.config.RepositoryServiceConfiguration</key>
    <type>org.exoplatform.services.jcr.impl.config.RepositoryServiceConfigurationImpl</type>
    <init-params>
      <value-param>
        <name>conf-path</name>
        <description>JCR configuration file</description>
        <value>war:/conf/jcr/repository-configuration.xml</value>
      </value-param>
      <properties-param>
        <name>working-conf</name>
        <description>working-conf</description>
        <property name="persister-class-name" value="org.exoplatform.services.jcr.impl.config.JDBCConfigurationPersister" />
        <property name="source-name" value="jcr_conf" />
        <property name="dialect" value="${gatein.jcr.datasource.dialect}" />
      </properties-param>
    </init-params>
  </component>

  <!-- MySQL configuration -->
  <component>
    <key>org.exoplatform.services.database.creator.DBCreator</key>
    <type>org.exoplatform.services.database.creator.DBCreator</type>
    <init-params>
      <properties-param>
        <name>db-connection</name>
        <description>database connection properties</description>
        <property name="driverClassName" value="com.mysql.jdbc.Driver" />
        <property name="url" value="jdbc:mysql://localhost:3306/" />
        <property name="username" value="cloudadmin" />
        <property name="password" value="cloud12321" />
        <property name="maxActive" value="5" />
        <property name="maxIdle" value="2" />
        <property name="initialSize" value="2" />
        <property name="validationQuery" value="select 1" />
        <property name="testOnReturn" value="true" />
        <property name="timeBetweenEvictionRunsMillis" value="300000" />
      </properties-param>
      <properties-param>
        <name>db-creation</name>
        <description>database creation properties</description>
        <property name="scriptPath" value="../${exo.conf.dir.name}/cloud/databases/mysqldb-schema.sql" />
        <property name="username" value="cloudadmin" />
        <property name="password" value="cloud12321" />
      </properties-param>
    </init-params>
  </component>

  <!-- passwords encrypter, mandatory for eXo Intranet migration -->
  <component>
    <key>org.exoplatform.services.security.PasswordEncrypter</key>
    <type>org.exoplatform.platform.security.MD5HexPasswordEncrypter</type>
  </component>

  <!-- org-service listener for password encryption, mandatory for eXo Intranet migration -->
  <external-component-plugins>
    <target-component>org.exoplatform.services.organization.OrganizationService</target-component>
    <component-plugin>
      <name>organization.initializer.group.event.listener</name>
      <set-method>addListenerPlugin</set-method>
      <type>org.exoplatform.platform.security.PasswordEncrypterUserListener</type>
      <description>description</description>
    </component-plugin>
    <component-plugin>
      <name>new.user.created.listener</name>
      <set-method>addListenerPlugin</set-method>
      <type>com.exoplatform.cloudworkspaces.organization.listener.UserLimitListener</type>
      <description>this listener controls users amount for a given workspace </description>
    ></component-plugin>
  </external-component-plugins>

  <!-- MySQL Configuration -->
  <external-component-plugins>
    <target-component>org.exoplatform.services.naming.InitialContextInitializer</target-component>
    <component-plugin>
      <name>bind.datasource</name>
      <set-method>addPlugin</set-method>
      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
      <init-params>
        <value-param>
          <name>bind-name</name>
          <value>${tenant.repository.name}</value>
        </value-param>
        <value-param>
          <name>class-name</name>
          <value>javax.sql.DataSource</value>
        </value-param>
        <value-param>
          <name>factory</name>
          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
        </value-param>
        <properties-param>
          <name>ref-addresses</name>
          <description>ref-addresses</description>
          <property name="driverClassName" value="com.mysql.jdbc.Driver" />
          <property name="url" value="jdbc:mysql://localhost:3306/${tenant.repository.name}" />
          <property name="username" value="clouduser" />
          <property name="password" value="cloud12321" />
          <property name="maxActive" value="50" />
          <property name="maxIdle" value="2" />
          <property name="initialSize" value="5" />
          <property name="validationQuery" value="select 1" />
          <property name="testOnReturn" value="true" />
          <property name="timeBetweenEvictionRunsMillis" value="300000" />
        </properties-param>
      </init-params>
    </component-plugin>
    <component-plugin>
      <name>bind.datasource</name>
      <set-method>addPlugin</set-method>
      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
      <init-params>
        <value-param>
          <name>bind-name</name>
          <value>jcr_conf</value>
        </value-param>
        <value-param>
          <name>class-name</name>
          <value>javax.sql.DataSource</value>
        </value-param>
        <value-param>
          <name>factory</name>
          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
        </value-param>
        <properties-param>
          <name>ref-addresses</name>
          <description>ref-addresses</description>
          <property name="driverClassName" value="com.mysql.jdbc.Driver" />
          <property name="url" value="jdbc:mysql://localhost:3306/jcr_conf_serv1" />
          <property name="username" value="clouduser" />
          <property name="password" value="cloud12321" />
          <property name="maxActive" value="50" />
          <property name="maxIdle" value="2" />
          <property name="initialSize" value="5" />
          <property name="validationQuery" value="select 1" />
          <property name="testOnReturn" value="true" />
          <property name="timeBetweenEvictionRunsMillis" value="300000" />
        </properties-param>
      </init-params>
    </component-plugin>
  </external-component-plugins>

  <!-- temporarily for 1.0.0-Beta2, PLF-2644 -->
  <external-component-plugins>
    <target-component>org.exoplatform.portal.config.UserPortalConfigService</target-component>
    <component-plugin>
      <name>intranent.portal.config.user.listener</name>
      <set-method>initListener</set-method>
      <type>org.exoplatform.portal.config.NewPortalConfigListener</type>
      <description>this listener init the portal configuration</description>
      <init-params>
        <value-param>
          <name>default.portal</name>
          <description>The default portal for checking db is empty or not</description>
          <value>intranet</value>
        </value-param>
        <object-param>
          <name>portal.configuration</name>
          <description>description</description>
          <object type="org.exoplatform.portal.config.NewPortalConfig">
            <field name="predefinedOwner">
              <collection type="java.util.HashSet">
                <value>
                  <string>intranet</string>
                </value>
              </collection>
            </field>
            <field name="ownerType">
              <string>portal</string>
            </field>
            <field name="templateLocation">
              <string>war:/conf/cloud-workspaces-extension/portal</string>
            </field>
          </object>
        </object-param>
      </init-params>
    </component-plugin>
  </external-component-plugins>

  <remove-configuration>org.exoplatform.platform.gadget.services.GroovyScript2RestLoader.GroovyScript2RestLoaderExt</remove-configuration>

</configuration>

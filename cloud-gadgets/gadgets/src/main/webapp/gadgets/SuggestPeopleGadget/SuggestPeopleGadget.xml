<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs author="eXoPlatform" title="SuggestPeopleGadget">
    <Require feature="opensocial-0.8" />
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[ 
    
    <head>
      <link type="text/css" rel="stylesheet" href="/exo-gadget-resources/skin/exo-gadget/gadget-common.css" />
      <link type="text/css" rel="stylesheet" href="css/people.css" />    
      <script language="javascript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      <script type="text/javascript">
        
        function sortByContacts(a, b){
          return b.contacts - a.contacts;
        }
        
        Array.prototype.shuffle = function() {
          var len = this.length;
          var i = len;
          while (i--) {
            var p = parseInt(Math.random()*len);
            var t = this[i];
            this[i] = this[p];
            this[p] = t;
          }
        };
        
        
        function initIncoming() {
          
          $.getJSON("/rest/gadgets/people/contacts/incoming", function(items){            
            
            if (items.length > 0){
              $("#peopleInvite").show();
              $("#emptyMessage").hide();
            }
            
            $.each(items, function(i, item){
              
              var link = "<li id='"+item.relationId+"'>";
              link += "<div class='peoplePicture' ><a href='#'><img src='"+item.avatar+"'></a></div>";
              link += "<div class='peopleInfo'>";
              link += "<div class='peopleName'><a href='"+item.profile+"' target='_parent'>"+item.senderName+"</a></div>";
              link += "<div class='peopleAction' ><a class='accept' href='#' onclick='return false'>Accept</a> | <a class='deny' href='#' onclick='return false'>Deny</a></div>";
              link += "</div></li>";
              
              $("#requests").append(link);  
              
              gadgets.window.adjustHeight();
              
              $("#"+item.relationId+" a.accept").live("click", function(){
                $.getJSON("/rest/gadgets/people/contacts/confirm/"+item.relationId, null);
                
                if($("#requests").children().length == 1) {
                  $("#peopleInvite").fadeOut(500, function () { 
                    $("#"+item.relationId).remove();
                    $("#peopleInvite").hide();
                    if ($("#peopleSuggest").is(":hidden")){
                        $("#emptyMessage").show();
                    }
                    gadgets.window.adjustHeight();
                  });
                }
                else {
                  $("#"+item.relationId).fadeOut(500, function () { 
                    $("#"+item.relationId).remove();
                    var count = parseInt($("#inviteCounter").html());
                    $("#inviteCounter").html(count-1);
                    gadgets.window.adjustHeight();
                  });
                }                                                    
              });
              
              $("#"+item.relationId+" a.deny").live("click", function(){
                $.getJSON("/rest/gadgets/people/contacts/deny/"+item.relationId, null);
                
                if($("#requests").children().length == 1) {
                  $("#peopleInvite").fadeOut(500, function () { 
                    $("#"+item.relationId).remove();
                    $("#peopleInvite").hide();
                    if ($("#peopleSuggest").is(":hidden")){
                        $("#emptyMessage").show();
                    }
                    gadgets.window.adjustHeight();
                  });
                }
                else {
                  $("#"+item.relationId).fadeOut(500, function () {
                    $("#"+item.relationId).remove();
                    var count = parseInt($("#inviteCounter").html());
                    $("#inviteCounter").html(count-1);
                    $('#suggestions li:hidden:first').fadeIn(500, function() {});
                    gadgets.window.adjustHeight();
                  });
                }                   
              });
              $("#inviteCounter").html(i+1);
            }); 
          });                
        }
        
        function initSuggestions() {
          
          $.getJSON("/rest/gadgets/people/contacts/suggestions", function(items){            
            
            if (items.length > 0){
              $("#peopleSuggest").show();
              $("#emptyMessage").hide();
            }
            
            items.shuffle();
            // sort my most contacts instead of random
            // items.sort(sortByContacts);            
            
            $.each(items, function(i, item){   
              
              var link = "";
              if (i < 2)
              { link += "<li id='"+item.suggestionId+"'>";}
              else
              { link += "<li style='display:none;' id='"+item.suggestionId+"'>" }
              
              link += "<div class='peoplePicture' ><a href='#'><img src='"+item.avatar+"'></a></div>";
              link += "<div class='peopleInfo'>";
              link += "<div class='peopleName'><a href='"+item.profile+"' target='_parent'>"+item.suggestionName+"</a></div>";
              link += "<div class='peopleAction' ><a class='connect' href='#' onclick='return false'>Connect</a> | <a class='ignore' href='#' onclick='return false'>Ignore</a></div>";
              link += "</div></li>";
              
              $("#suggestions").append(link);           
              
              gadgets.window.adjustHeight();
              
              $("#"+item.suggestionId+" a.connect").live("click", function(){
                $.getJSON("/rest/gadgets/people/contacts/connect/"+item.suggestionId, null);
                
                if($("#suggestions").children().length == 1) {
                  $("#peopleSuggest").fadeOut(500, function () {   
                    $("#"+item.relationId).remove();
                    $("#peopleSuggest").hide();
                    if ($("#peopleInvite").is(":hidden")){
                        $("#emptyMessage").show();
                    }
                    gadgets.window.adjustHeight();
                  });  
                }
                else {
                  $("#"+item.suggestionId).fadeOut(500, function () {   
                    $("#"+item.suggestionId).remove();
                    $('#suggestions li:hidden:first').fadeIn(500, function() {});
                    gadgets.window.adjustHeight();
                  });   
                }                  
              });
              
              $("#"+item.suggestionId+" a.ignore").live("click", function(){
                //$.getJSON("/rest/gadgets/people/contacts/ignore/"+item.suggestionId, null);
                if($("#suggestions").children().length == 1) {
                  $("#peopleSuggest").fadeOut(500, function () {   
                    $("#"+item.relationId).remove();
                    $("#peopleSuggest").hide();
                    if ($("#peopleInvite").is(":hidden")){
                        $("#emptyMessage").show();
                    }
                    gadgets.window.adjustHeight();
                  });  
                }
                else {
                  $("#"+item.suggestionId).fadeOut(500, function () {   
                    $("#"+item.suggestionId).remove();
                    $('#suggestions li:hidden:first').fadeIn(500, function() {});
                    gadgets.window.adjustHeight();
                  });  
                }
              });
              
            }); 
          });                
        }
        
        gadgets.util.registerOnLoadHandler(function(){  
          
          gadgets.window.adjustHeight();
          initIncoming();
          initSuggestions();
        });
        
      </script>         
      
    </head>
    
    <body >
      <div id="content" >
        
        <div id="PeopleGadget" class="UIGadgetThemes">
          
          <div id="emptyMessage">Send invitations to connect with your coworkers!</div>
                    
          <div style="display:none;" class="peopleList" id="peopleInvite">
              <div class='peopleHeader'>Connection Requests (<span id='inviteCounter'></span>)</div><ul id='requests'></ul>
          </div>
          
          <div style="display:none;" class="peopleList" id="peopleSuggest">
              <div class='peopleHeader'>Connection Suggestions</div><ul id='suggestions'></ul>
          </div>
          
        </div>
      </div>
      
    </body>
    
    
    ]]></Content></Module>